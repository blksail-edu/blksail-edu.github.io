---
sidebar_position: 3
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import Image from "@theme/IdealImage";

# 3.3 Sensor-Driven Autonomy

## Gazebo

[Gazebo](https://gazebosim.org/) is a set of open source tools for simulating robots in an environment.
It is commonly used in robotics research and education.

We will be using Gazebo to simulate the BlueROV2 robot in a virtual pool environment.

:::note

We will be using `Gazebo Harmonic`, the latest LTS version of Gazebo.

:::

### Installation

The documentation for installing Gazebo can be found [here](https://gazebosim.org/docs/garden/install).
See "**Binary Installation**" for instructions on installing Gazebo on your operating system.
Below is a summary of the steps.

:::note

Only Ubuntu is fully supported by Gazebo, and macOS is partially supported. On Windows the simulation will run in the WSL environment.

:::

<Tabs groupId="operating-systems">
<TabItem value="macos" label="macOS">

First we need to install ruby from Homebrew:

```bash
brew install ruby
```

Then we have to add the Homebrew Ruby to our path:

```bash
echo 'export PATH="$(brew --prefix)/opt/ruby/bin:$PATH"' >> ~/.zshrc
```

Now, we add the `osrf/simulation` tap:

```bash
brew tap osrf/simulation
```

:::tip Apple Silicon-based Macs

For Apple Silicon-based Macs, we need to modify the Formulae before installing Gazebo.

```bash
cd /opt/homebrew/Library/Taps/osrf/homebrew-simulation/Formula
sed -i '' 's|cmake_args << "-DCMAKE_INSTALL_RPATH=#{rpath}"|cmake_args << "-DCMAKE_INSTALL_RPATH=#{rpath};/opt/homebrew/lib"|' *.rb
```

:::

Next we install Gazebo:

```bash
brew install gz-harmonic
```

</TabItem>
<TabItem value="ubuntu" label="Ubuntu">

First, **in a WSL terminal**, update and install dependencies:

```bash
sudo apt update
sudo apt install lsb-release wget gnupg
```

Next, install the Gazebo package repository:

```bash
sudo wget https://packages.osrfoundation.org/gazebo.gpg -O /usr/share/keyrings/pkgs-osrf-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/pkgs-osrf-archive-keyring.gpg] http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null
```

Finally, install `Gazebo Harmonic`:

```bash
sudo apt update
sudo apt install gz-harmonic
```

</TabItem>
</Tabs>

### Testing

To test your installation, run the following command:

<Tabs groupId="operating-systems">
<TabItem value="macos" label="macOS">

In one terminal, run:

```bash
gz sim -v4 -s shapes.sdf
```

In another terminal, run:

```bash
gz sim -v4 -g
```

</TabItem>
<TabItem value="ubuntu" label="Ubuntu">

In one terminal, run:

```bash
gz sim -v4 shapes.sdf
```

You should see a window pop up with some 3D objects in it.

:::info

For **`WSL`** users, hardware acceleration (GPU) may not work properly inside of the virtual environment. If your simulation seems laggy, you can try switching to software acceleration (CPU). 

To do so, add the following line to your `WSL`'s `.zshrc` file:

```zsh
export LIBGL_ALWAYS_SOFTWARE=1
```

Then, source `.zshrc` in your `WSL` terminal and restart the simulation.

```zsh
source ~/.zshrc
```

:::

</TabItem>
</Tabs>

## BlueROV2 Simulation

### Installation

In this course, you will use a custom simulation for the BlueROV2. To install the simulation, **clone the repository onto your macOs, Windows WSL, or Ubuntu machine**:

```zsh
git clone https://github.com/blksail-edu/gazebo_bluerov2
```

<Tabs groupId="operating-systems">
<TabItem value="macos" label="macOS">

Dr. Saad it is your time to shine !

</TabItem>
<TabItem value="ubuntu" label="Ubuntu">

Install the following dependencies:

```zsh
sudo apt install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev rapidjson-dev libopencv-dev
```

Navigate to the `gazebo_bluerov2` repository, and then run the build command:

```zsh
./build.sh
```

After the build is complete, you can start the simulation with:

```zsh
./launch.sh
```

:::info

The `./` in the command is the relative path to the `build.sh` and `launch.sh` files. As is, the above commands only run if your working directory is the `gaebo_bluerov2` directory.

:::

</TabItem>
</Tabs>

### Environment Setup

Now that you can run the BlueROV2 Gazebo simulation, the Gazebo simulation must be bridged with ROS 2. 

:::info

If you are using Windows with WSL, follow the Windows tab rather than the Ubuntu tab when applicable.

:::



{/* 
We built a custom simulation for the BlueROV2.
It lives in this repository: [gazebo_bluerov2](https://github.com/blksail-edu/gazebo_bluerov2).

Clone the repository into your workspace:

```bash
git clone https://github.com/blksail-edu/gazebo_bluerov2
```

Build the simulation:

```bash
cd gazebo_bluerov2
./build.sh
```

Start the example simulation:

```bash
./launch.sh
```

:::warning

Sometimes, the simulation will not quit properly.
If this happens, you will need to kill the process manually.

```bash
pkill -9 gz
```

:::

![Gazebo BlueROV2](gz-sim.png)

## Controlling the robot

Try controlling the depth of robot now with `depth_control.py` you previously wrote.

First, in the `backseat`, start the `SITL`:

```bash
cd PATH_TO_ARDUSUB
Tools/autotest/sim_vehicle.py -L RATBeach -v ArduSub -f vectored --model=JSON --out=udp:SIMULATION_COMPUTER_IP:14550 --console
```

Run your `depth_control.py` script in another terminal:

```bash
python3 depth_control.py
```

You should see the robot dive to the desired depth.
 */}