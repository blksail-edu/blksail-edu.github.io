"use strict";(self.webpackChunkblksail_edu_github_io=self.webpackChunkblksail_edu_github_io||[]).push([[5568],{7497:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"module/ros2_with_ardusub","title":"2.4 ArduSub & ROSMAV","description":"In this section, we explore ArduSub and rosmav.","source":"@site/docs/2-module/40_ros2_with_ardusub.mdx","sourceDirName":"2-module","slug":"/module/ros2_with_ardusub","permalink":"/docs/module/ros2_with_ardusub","draft":false,"unlisted":false,"editUrl":"https://github.com/blksail-edu/blksail-edu.github.io/tree/main/docs/2-module/40_ros2_with_ardusub.mdx","tags":[],"version":"current","sidebarPosition":40,"frontMatter":{"slidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"2.3 Virtual Environments","permalink":"/docs/module/ros2_in_venv"},"next":{"title":"2.5 Launch Files","permalink":"/docs/module/launch_files"}}');var o=s(4848),i=s(8453);const l={slidebar_position:4},t="2.4 ArduSub & ROSMAV",a={},c=[{value:"Installing ArduSub",id:"installing-ardusub",level:2},{value:"Testing ArduSub",id:"testing-ardusub",level:2},{value:"Installing ROSMAV",id:"installing-rosmav",level:2},{value:"Launching ROSMAV",id:"launching-rosmav",level:2},{value:"Problem Set",id:"problem-set",level:2},{value:"Problem One",id:"problem-one",level:3},{value:"Problem Two",id:"problem-two",level:3}];function d(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"24-ardusub--rosmav",children:"2.4 ArduSub & ROSMAV"})}),"\n",(0,o.jsxs)(n.p,{children:["In this section, we explore ",(0,o.jsx)(n.code,{children:"ArduSub"})," and ",(0,o.jsx)(n.code,{children:"rosmav"}),".\nArduSub is a fork of ArduPilot, a flight controller software that runs onboard the BlueROV2 through ",(0,o.jsx)(n.code,{children:"BueOS"}),". The ArduSub software utilizes the ",(0,o.jsx)(n.code,{children:"MAVLINK"})," communication protocol to control the motors, receive sensor data, etc.\nYou will connect to the BlueROV2 through ROS 2 using a custom ",(0,o.jsx)(n.code,{children:"rosmav"})," interface. This interface uses the ",(0,o.jsx)(n.code,{children:"MAVLINK"}),' communication protocal inside of a ROS 2 node to talk to the "',(0,o.jsx)(n.em,{children:"frontseat"}),'" onboard the vehicle.']}),"\n",(0,o.jsx)(n.h2,{id:"installing-ardusub",children:"Installing ArduSub"}),"\n",(0,o.jsxs)(n.p,{children:["For the purposes of this problem set and future simulations (with QGroundControl), you must install ",(0,o.jsx)(n.code,{children:"ArduSub"}),".\nWhen you interface with the ROVs themselves, you'll connect to a ",(0,o.jsx)(n.code,{children:"SITL"})," running onboard and therefore you will not need to run your own."]}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"You must install ArduSub while you are in a virtual environment on the Raspberry Pi!"})}),"\n",(0,o.jsxs)(n.p,{children:["Open a terminal on the ",(0,o.jsx)(n.code,{children:"backseat"})," and install ",(0,o.jsx)(n.code,{children:"ArduSub"})," from our repository:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"cd && git clone --recurse-submodules https://github.com/blksail-edu/ardupilot\ncd ~/ardupilot\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Then, create a new virtual environment for ",(0,o.jsx)(n.code,{children:"ArduSub"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"mkvirtualenv ardusub\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Installing the following python libraries into the ",(0,o.jsx)(n.code,{children:"ardusub"})," virtual environment:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"pip install empy==3.3.4 pexpect mavproxy future dronecan setuptools pyyaml\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Also install the ",(0,o.jsx)(n.code,{children:"ccache"})," system library and remove the ",(0,o.jsx)(n.code,{children:"modemmanager"})," system library:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"sudo apt install ccache -y\nsudo apt remove modemmanager -y\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now, configure the ",(0,o.jsx)(n.code,{children:"ArduPilot"})," repository:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"./waf configure\n. ~/.profile\n./waf clean\n"})}),"\n",(0,o.jsxs)(n.p,{children:["With your favorite text editor, add the following commands to the ",(0,o.jsx)(n.code,{children:".zshrc"})," file on the ",(0,o.jsx)(n.code,{children:"backseat"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"export PATH=$PATH:$HOME/ardupilot/Tools/autotest\nexport PATH=/usr/lib/ccache:$PATH\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Source the ",(0,o.jsx)(n.code,{children:".zshrc"})," file and reactivate the ",(0,o.jsx)(n.code,{children:"ardusub"})," virtual environment:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"source ~/.zshrc\nworkon ardusub\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Next, install the ",(0,o.jsx)(n.code,{children:"gcc-arm cross-compiler"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"cd ~/ardupilot && mkdir TARGET_DIR && cd TARGET_DIR\nwget -c https://firmware.ardupilot.org/Tools/STM32-tools/gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux.tar.bz2\n"})}),"\n",(0,o.jsx)(n.p,{children:"Unpack the compiler:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"tar -xjvf gcc-arm-none-eabi-10-2020-q4-major-x86_64-linux.tar.bz2\n"})}),"\n",(0,o.jsxs)(n.p,{children:["With your favorite text editor, add the following line to the ",(0,o.jsx)(n.code,{children:".zshrc"})," file on the ",(0,o.jsx)(n.code,{children:"backseat"})," to add the compiler to path:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"export PATH=$PATH:$HOME/ardupilot/TARGET_DIR/gcc-arm-none-eabi-10-2020-q4-major/bin\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Then, source the ",(0,o.jsx)(n.code,{children:".zshrc"})," file again and reactivate the ",(0,o.jsx)(n.code,{children:"ardusub"})," virtual environment:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"source ~/.zshrc\nworkon ardusub\n"})}),"\n",(0,o.jsx)(n.p,{children:"Lastly, install the geographic library datasets:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"cd && wget https://raw.githubusercontent.com/mavlink/mavros/ros2/mavros/scripts/install_geographiclib_datasets.sh\nchmod +x ./install_geographiclib_datasets.sh\nsudo ./install_geographiclib_datasets.sh\n"})}),"\n",(0,o.jsx)(n.h2,{id:"testing-ardusub",children:"Testing ArduSub"}),"\n",(0,o.jsxs)(n.p,{children:["In a terminal on the ",(0,o.jsx)(n.code,{children:"backseat"}),", you may now start the software in the loop (SITL)."]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"The first time you start the SITL, it will approximately 30 minutes to configure."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:'~/ardupilot/Tools/autotest/sim_vehicle.py --vehicle=ArduSub --aircraft="bwsibot" -L RATBeach --out=udp:192.168.3.1:14550\n'})}),"\n",(0,o.jsx)(n.h2,{id:"installing-rosmav",children:"Installing ROSMAV"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["First, create a new virutal environment for the ",(0,o.jsx)(n.code,{children:"rosmav"})," interface."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"mkvirtualenv rosmav --system-site-packages\nworkon rosmav\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"2",children:["\n",(0,o.jsxs)(n.li,{children:["Install the following libraries in the ",(0,o.jsx)(n.code,{children:"rosmav"})," virtual environment."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"pip install cv_bridge numpy pymavlink\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsxs)(n.li,{children:["Now, clone the ",(0,o.jsx)(n.code,{children:"rosmav"})," repository into the ",(0,o.jsx)(n.code,{children:"src"})," directory of your ",(0,o.jsx)(n.code,{children:"auvc_ws"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"cd ~/auvc_ws/src && git clone https://github.com/blksail-edu/rosmav\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"4",children:["\n",(0,o.jsxs)(n.li,{children:["Install ROS 2 dependencies for ",(0,o.jsx)(n.code,{children:"rosmav"}),":"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"sudo rosdep init\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"rosdep update\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"cd ~/auvc_ws && rosdep install --from-paths src --ignore-src -r -y\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"5",children:["\n",(0,o.jsxs)(n.li,{children:["Compile the ",(0,o.jsx)(n.code,{children:"rosmav"})," package and source the workspace."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"colcon build --packages-select rosmav && source install/setup.zsh\n"})}),"\n",(0,o.jsx)(n.h2,{id:"launching-rosmav",children:"Launching ROSMAV"}),"\n",(0,o.jsxs)(n.p,{children:["After building the ",(0,o.jsx)(n.code,{children:"rosmav"})," package, test the interface by running the following command in a terminal on the backseat:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"ros2 run rosmav ros_bluerov2_interface\n"})}),"\n",(0,o.jsx)(n.p,{children:"If the command runs successfully, you should see the following output:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-zsh",children:"[INFO] [1721669754.194733875] [ros_bluerov2_interface]: Heartbeat from system 1, component 0\n"})}),"\n",(0,o.jsx)(n.h2,{id:"problem-set",children:"Problem Set"}),"\n",(0,o.jsxs)(n.p,{children:["For this problem set, please first create a new ROS 2 package named ",(0,o.jsx)(n.code,{children:"tutorial_ardusub"})," to contain any new nodes that you create."]}),"\n",(0,o.jsx)(n.h3,{id:"problem-one",children:"Problem One"}),"\n",(0,o.jsxs)(n.p,{children:["In your ",(0,o.jsx)(n.code,{children:"tutorial_ardusub"})," package, create a new node called ",(0,o.jsx)(n.code,{children:"bluerov2_sensors.py"}),". This node should do the following:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Subscribe to the battery sensor messages."}),"\n",(0,o.jsx)(n.li,{children:"Subscribe to the inertial measurement unit (IMU) sensor messages."}),"\n",(0,o.jsx)(n.li,{children:"Use attributes that are updated on subscription callbacks."}),"\n",(0,o.jsx)(n.li,{children:"Output a warning in the terminal when the battery has fallen below a safe voltage."}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["When both ",(0,o.jsx)(n.code,{children:"ArduSub"})," and ",(0,o.jsx)(n.code,{children:"ROSMAV"})," are running on the ",(0,o.jsx)(n.code,{children:"backseat"}),", the ",(0,o.jsx)(n.code,{children:"SITL"})," will send simulated messages that you can use to test your node."]})}),"\n",(0,o.jsx)(n.h3,{id:"problem-two",children:"Problem Two"}),"\n",(0,o.jsxs)(n.p,{children:["Open ",(0,o.jsx)(n.code,{children:"QGroundControl"})," on your Windows or macOs machine. You should see the BlueROV2 somewhere along the United State's west coast. This BlueROV2 is the ",(0,o.jsx)(n.code,{children:"SITL"})," running on the ",(0,o.jsx)(n.code,{children:"backseat"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["If it is not already running, start your node from ",(0,o.jsx)(n.strong,{children:"Problem One"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["In ",(0,o.jsx)(n.code,{children:"QGroundControl"}),", arm the BlueROV2 and change its flight mode to ",(0,o.jsx)(n.code,{children:"GUIDED"}),". Click any arbitrary point in the water and select ",(0,o.jsx)(n.code,{children:"Go to location"}),". After holding down your space bar or dragging the slider, you should see the BlueROV2 moving."]}),"\n",(0,o.jsxs)(n.p,{children:["Open a new terminal on the ",(0,o.jsx)(n.code,{children:"backseat"})," and use the ",(0,o.jsx)(n.code,{children:"ros2 topic echo"})," command to inspect the available topics. Also pay attention to your node. What do you observe?"]}),"\n",(0,o.jsx)(n.admonition,{title:"Check-off",type:"warning",children:(0,o.jsx)(n.p,{children:"Review with a TA or instructor to check-off this section."})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>t});var r=s(6540);const o={},i=r.createContext(o);function l(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);